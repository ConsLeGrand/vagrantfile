# Define required providers
terraform {
required_version = ">= 0.14.0"
  required_providers {
    openstack = {
      source  = "terraform-provider-openstack/openstack"
      version = "~> 1.51.1"
    }
  }
}
provider "openstack" {
  user_name   = "admin"
  tenant_name = "admin"
  password    = "2GRGt7H3z8mYvmY47atZwwa6CCTesvPo"
  auth_url    = "https://192.168.50.133:5000/v3/"
  region      = "RegionOne"
  insecure    = "true"
}

resource "openstack_compute_keypair_v2" "keypair" {
  name = "my-keypair"
}

resource "openstack_compute_instance_v2" "srv_web1" {
  name            = "srv_web1"
  image_id        = "543f9373-582e-4ad2-86d9-208797d25ee8" 
  flavor_id       = "4" 
  key_pair        = openstack_compute_keypair_v2.keypair.name
  security_groups = ["default"]
}

resource "openstack_networking_secgroup_rule_v2" "allow_http" {
  direction      = "ingress"
  ethertype      = "IPv4"
  protocol       = "tcp"
  port_range_min = 80
  port_range_max = 80
  security_group_id = openstack_compute_instance_v2.srv_web1.security_groups.0
}

# Remote-exec provisioner to install Nginx and replace the default page with a custom page
resource "null_resource" "configure_nginx" {
  connection {
    host        = openstack_compute_instance_v2.srv_web1.access_ip_v4
    type        = "ssh"
    user        = "ubuntu" # Replace with the SSH user for your image (e.g., ubuntu, centos, etc.)
    private_key = file("~/.ssh/id_rsa") # Replace with the path to your SSH private key
  }

  provisioner "remote-exec" {
    inline = [
      "sudo apt-get update",
      "sudo apt-get install -y nginx",
      "echo '<h1>Welcome to My Nginx Server!</h1>' | sudo tee /var/www/html/index.html",
      "sudo systemctl restart nginx"
    ]
  }
}
